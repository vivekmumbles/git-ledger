
<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>git-ledger data</title>
	<script src="lib/d3/d3.js"></script>
	<style type="text/css">

	</style>
</head>
<body>
	<script type="text/javascript">

	// TODO: use d3 not synchronous flag


	var URL = 'https://github.com/vivekmumbles/slates';

	function getTreeSHA(url) {
		var prefix = 'https://api.github.com/repos/';
		var suffix = '/git/refs/heads/master';
		var loc = url.split('.com/')[1];

		var rurl = prefix+loc+suffix;
		var request = new XMLHttpRequest();
		request.open('GET', rurl, false);
		request.send();  
		return JSON.parse(request.response).object.sha;
	}

	function Node(path) {
		this.path = path;
		this.contributions = {};
		this.files = [];
	}

	function getNode(node, path) {
		if (node.path === path) return node;
		var parent = null;
		for (var i = 0; i < node.files.length; ++i) {
			parent = getNode(node.files[i], path);
		}
		return parent;
	}

	function addNode(node, childPath, parentPath) {
		var child = new Node(childPath);
		var parent = getNode(node, parentPath);
		parent.files.push(child);
	}

	function populateTree(root, data) {
		for (var i = 0; i < data.length; ++i) {
			data[i].path = '/'+data[i].path;
			var idx = data[i].path.lastIndexOf('/');
			var parent = '/';
			if (idx > 0) {
				parent = data[i].path.substring(0,idx);
			}
			addNode(root, data[i].path, parent);
		}
	}

	function getCommits(path) {
		var contributions = {};
		var prefix = 'https://api.github.com/repos/';
		var suffix = '/commits?'+path;
		var loc = URL.split('.com/')[1];

		var rurl = prefix+loc+suffix;
		var request = new XMLHttpRequest();
		request.open('GET', rurl, false);
		request.send();

		console.log(path);

		var response = JSON.parse(request.response);

		console.log(response);

		for (var i = 0; i < response.length; ++i) {
			var detailsURL = response[i].url;
			request = new XMLHttpRequest();
			request.open('GET', detailsURL, false);
			request.send();
			var details = JSON.parse(request.response);
			console.log(details);
			var user = details.committer.login;
			var files = details.files;
			for (var j = 0; j < files.length; ++j) {
				// console.log('/'+files[j].filename)
				// console.log(path)
				if ('/'+files[j].filename === path) {
					// console.log(files);
					if (contributions[user] === undefined) {
						contributions[user] = files[j].changes;
					} else {
						contributions[user] += files[j].changes;
					}
				}
			}
		}
		// console.log(contributions);
		return contributions;
	}

	function combineContributions(a, b) {
		var result = {};
		for (var key in a) {
			result[key] = a[key];
		}
		for (var key in b) {
			if (result[key] === undefined) result[key] = b[key];
			else result[key] += b[key]; 
		}
		return result;
	}

	function getContributions(node) {
		if (node.files.length === 0) {
			node.contributions = getCommits(node.path);
			// console.log(node.contributions);
			return node.contributions;
		}
		for (var i = 0; i < node.files.length; ++i) {
			node.contributions = combineContributions(node.contributions, 
				getContributions(node.files[i]));
			break;
		}
		return node.contributions;
	}

	function getTree(url, sha) {
		var prefix = 'https://api.github.com/repos/';
		var suffix = '/git/trees/'+sha+'?recursive=1';
		var loc = url.split('.com/')[1];

		var rurl = prefix+loc+suffix;
		var request = new XMLHttpRequest();
		request.open('GET', rurl, false);
		request.send();  
		var response = JSON.parse(request.response);
		return response.tree;
	}

	var rootSHA = getTreeSHA(URL);
	var root = new Node('/');
	var tree = getTree(URL, rootSHA);
	populateTree(root, tree);
	getContributions(root);
	</script>
</body>
</html>