
<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>git-ledger data</title>
	<script src="lib/d3/d3.js"></script>
	<style type="text/css">

	</style>
</head>
<body>
	<script type="text/javascript">

	// TODO: use d3 not synchronous flag


	var URL = 'https://github.com/vivekmumbles/slates';

	function getTreeSHA(url) {
		var prefix = 'https://api.github.com/repos/';
		var suffix = '/git/refs/heads/master';
		var loc = url.split('.com/')[1];

		var rurl = prefix+loc+suffix;
		var request = new XMLHttpRequest();
		request.open('GET', rurl, false);
		request.send();  
		return JSON.parse(request.response).object.sha;
	}

	function Node(path) {
		this.path = path;
		this.contributors = {};
		this.files = [];
	}

	function getNode(node, path) {
		if (node.path === path) return node;
		var parent = null;
		for (var i = 0; i < node.files.length; ++i) {
			parent = getNode(node.files[i], path);
		}
		return parent;
	}

	function addNode(node, childPath, parentPath) {
		var child = new Node(childPath);
		var parent = getNode(node, parentPath);
		parent.files.push(child);
	}

	function populateTree(root, data) {
		for (var i = 0; i < data.length; ++i) {
			data[i].path = '/'+data[i].path;
			var idx = data[i].path.lastIndexOf('/');
			var parent = '/';
			if (idx > 0) {
				parent = data[i].path.substring(0,idx);
			}
			addNode(root, data[i].path, parent);
		}
	}

	function getTree(url, sha) {
		var prefix = 'https://api.github.com/repos/';
		var suffix = '/git/trees/'+sha+'?recursive=1';
		var loc = url.split('.com/')[1];

		var rurl = prefix+loc+suffix;
		var request = new XMLHttpRequest();
		request.open('GET', rurl, false);
		request.send();  
		var response = JSON.parse(request.response);
		return response.tree;
	}

	var rootSHA = getTreeSHA(URL);
	var root = new Node('/');
	var tree = getTree(URL, rootSHA);
	populateTree(root, tree);
	</script>
</body>
</html>